当今许多新型应用都属于**数据密集型(data-intensive)**，而不是计算密集型(computer-intensive)。

对于这类应用，**CPU的处理能力往往不是第一限制性因素**，关键在于数据量、数据的复杂性和数据的快速多变性。

核心设计目标：可靠、可扩展 和 可维护的数据系统。

### 可靠性（Reliability）

当出现意外情况如硬件、软件故障、人为失误等，系统应该可以继续正常运转。 

**即使发生了某些错误，系统仍可以继续正常工作。**虽然性能可能有所降低，但要确保功能正确。

Work under failure. 

容错（fault-tolerant），弹性(resilient)

在不可靠组件基础上构建可靠性系统。通常不太可能将各个组件的故障概率降低到零，一般会设计容错机制来避免某些组件的故障引发系统失效。

谈容错时总是要说明在特定的范围内，这样谈系统容错才有意义。例如如果地球毁灭了，这时要想容错就必须在宇宙范围内进行系统冗余。

Netflix 的 **Chaos Monkey** 系统通过故意引发故障的方式，来持续检验、测试系统的容错机制。

#### 硬件故障

当有很多机器时，硬件故障迟早会发生。

为硬件添加冗余来减少系统故障率：磁盘配置RAID，服务器配备双电源、数据中心添加备用电源或发电机，甚至热插拔CPU等。

当一个组件发生故障，冗余组件能够快速接管，之后再更换失效的组件。

除非存在某种弱相关（例如一些共性原因，如服务器机架温度过高），否则通常不太可能出现大量硬件组件同时失效的情况。

#### 软件错误

软件故障更加难以预料，且因为节点之间是由软件关联的，可能出现大量软件组件同时失效的情况。

#### 人为失误

即使有时意图是好的，但人却无法做到万无一失。运维者的配置错误往往是系统下线的首要原因。

- 精心设计系统，对系统概念进行合理的抽象，使“做正确的事情”很轻松，但搞坏很复杂。一个好的设计抽象可以隐藏大量的实现细节，并对外提供干净、易懂的接口。
- 提供一个功能齐全但非生产用的sandbox环境，使人们可以放心尝试。万一出现问题，不会影响真实用户。
- 充分的测试。CI/CD 自动化测试，尽量减少人的参与，人是最不稳定的因素。
- 快速回滚的能力。逐步的release，而不是一下子将新的feature全部对外发布。
- 详细而清晰的监控。
- ACL 权限控制，服务器、机房要确保只能某些特定的人才能进入。

### 可扩展性（Scalability）

随着规模的增长，例如数据量、流量或复杂性，系统能够以合理的方式来匹配这种增长。

#### 描述性能

throughput, response time, latency.

批处理系统（如Hadoop）关心的是**吞吐量（throughput）**，即每秒可处理的记录条数，或者在指定数据集上运行Job所需的总时间。

在线系统通常更看重服务的响应时间（response time）。即客户端发送request到接收response之间的间隔。

**response time：**是客户端看到的，除了包含服务器处理时间外，还包括来回的网络延迟和各种排队时间。

**latency：**单独指服务器的处理时间。Server side需要的时间。

平均值并不是考察response time合适的指标，因为它掩盖了一些信息。

最好使用**百分位数（percentiles）**。**中位数（median）**是一个特殊的百分位数，如果response time的中位数是200ms，那意味着有一半的response不到200ms，而另一半的response超过200ms。

中位数就是P50。常用的其它百分位数还有P95、P99、P999，它们分别表示有95%、99%、99.9%的response time快于阈值。

例如，如果P95是1.5s，这意味着100个请求中有95个请求快于1.5s，而有5个请求需要1.5s或更长时间。

服务质量目标（Service Level Objectives，SLO）和服务质量协议（Service Level Agreements， SLA）这些是规定服务预期质量和可用性的合同。例如一份SLA会声明response time的中位数小于200ms，99%的response time小于1s，且要求99%的时间都要达到上述服务指标。并允许客户在不符合SLA的情况下进行赔偿。

**队头阻塞：**由于服务器并行处理的request有限（cpu内核数的限制），正在处理的少数request可能会阻塞后续request。即使后续request可能处理很简单，但仍会阻塞在等待前面的request完成，客户端会观察到极慢的response time。

**所以在客户端测量 response time很重要。**

#### 应对负载增加的方法

垂直扩展（scale up） OR 水平扩展（scale out）

把无状态服务分布扩展至多台机器比较容易，而有状态服务从单个节点扩展到分布式多个节点的复杂性会大大增加。

### 可维护性（Maintainability）

随着时间的推移，许多新的人员参与到系统开发和运维，以维护现有功能或适配新场景等，系统都应高效运转。









































