## 关系型数据库的问题

关系型数据库的扩展性很差。

在所有相对规范的关系型数据库中，都需要通过join操作从多个表中查询数据，而这种join操作可能速度很慢，并且在分布式环境下join操作的成本非常高昂。

关系型数据库通过事务保证一致性，这就需要锁定数据库的某个部分，使其它客户无法访问。在负载很大的情况下，这可能是难以接受的。且在分布式环境下，传统事务的ACID也会退化成BASE。

关系模型也不是十全十美的。例如在处理“多对多”关系时需要创建一个连接表，这就污染了原本简洁的数据模型。

一旦需要处理很多表中的大量数据行，复杂的查询和大量join操作就会导致应用运行及其缓慢。

总之，当数据量非常大时，单机的关系型数据库系统很难支撑。当通过分库分表等方式对关系型数据库进行扩展后，原本使用关系型数据库的那些优势（如维护模型间关系的join操作、事务ACID特性等）都无法继续正常保持，且分库分表这种扩展方式非常不利于数据库集群的扩容和缩容。所以，在数据量非常大的时候，关系型数据库原本的优势无法正常工作，水平扩展性又很差， 就不适合再继续被采用了。

## NoSQL的优势

1. 支持关系型数据库标准以外的数据模型。
2. 没有集中控制的分布式系统。它们强调水平可扩展性和高可用性，在某些情况下可能会牺牲强一致性和ACID语义作为代价。

## Cassandra介绍

Cassandra是一个开源、分布式、去中心化、弹性可扩展、高可用、可调一致性、面向行的数据库。

它的分布式设计基于Amazon Dynamo，数据模型基于Google BigTable。由Facebook创建。

### 分布式与去中心化

如果只运行一个Cassandra节点，那没有任何意义。需要多台机器才能体现出Cassandra的优势。

Cassandra不仅可以跨多个不同的节点运行，而且特别针对**多数据中心**、**多机架**部署进行了性能优化。甚至一个Cassandra集群能够跨分散于**多地**的数据中心运行。

Cassandra是去中心化的，它没有中心控制节点，也没有主/从副本的概念；所有的节点都是一样的。

所有Cassandra节点都不会做与其它节点不同的管理工作，**所有节点的功能都完全一样**。这意味着**Cassandra不存在单一故障点**。

而MySQL、BigTable、MongoDB和很多其它数据库都是主/从架构的。

相比于主/从架构，操纵和维护一个去中心化数据库集群更容易，因为所有的节点都是一样的，扩展数据库并不需要任何特殊知识，部署50个节点与部署一个节点没有什么不同。

### 弹性可扩展

弹性可扩展（Elastic Scalability）表示你的集群可以**无缝地**向上和向下扩展。

只要增加**一台**新的机器，Cassandra就能发现这个新的节点，并让它开始工作。不需要重新配置整个集群，也无需重启任何服务，不用修改你的应用查询，也不用你自己手动地重新平衡数据分布。

### 高可用

Cassandra是高可用的。你可以更换集群中的故障节点而不中断系统，另外可以把数据复制到多个数据中心来提供更好的本地性能。如果一个数据中心遭遇地震、火灾等灾害时也能防止系统彻底瘫痪。

### 可调一致性

一致性的定义：读操作总是返回最新写入的值。

CAP：在数据一致性、节点可用性、分区容错性之间进行折中。只能实现其中两个目标，不能三者同时满足。

分布式数据库设计者必须做出选择，要么让系统总是可读，要么总是可写。

Dynamo 和 Cassandra 选择让系统总是可写，把解决冲突的复杂性留给读操作，性能得到了很大提升。

**可调一致性**：客户端可以控制对于所有写操作要阻塞的副本数。

**副本因子**：它是一个节点数，表示你希望一份数据副本存储在集群中多少个节点上。

**一致性级别（consistency level）**是客户端每次操作时都必须指定的一个参数，可以通过这个参数确定集群中有多少个副本确认一个写操作或响应一个读操作时，就认为那个操作是成功的。Cassandra让用户自己来做这个决定。

例如，可以把一致性级别设置为等于副本因子数，这样可以得到强一致性，但需要付出同步阻塞操作的代价，这会消弱可用性，影响性能，而往往这与你使用Cassandra的初衷相悖。如果客户将一致性级别设置为小于副本因子的值，即使有些节点宕机，仍然可以认为操作成功。

#### CAP理论

**一致性（Consistency）**：对于相同的查询，所有数据库客户端要读取相同的值，即使存在并发更新也要保证这一点。

**可用性（Availability）：**所有数据库客户端总是能读写数据。

**分区容错性（Partition tolerance）**：数据可以分布到多台机器上，即使网络分区通信中断，仍能继续工作。

这三者之中只能取其二。例如，如果要求系统确保强一致性，就只能有较低的分区容错性，或者在可用性方面做一些让步。

分布式系统**必须**在有网络分区的情况下尽可能继续工作（必须具备分区容错性，网络丢包、长延迟等问题是客观存在的），所以实际上我们只能在剩下的两个特性里二选一：**可用性 or 一致性**。

**CA**：如果出现网络分区，系统就会阻塞，所以这类系统可能要求全部节点必须部署在一个数据中心内（跨数据中心网络更差）。很多采用**同步复制**的关系型数据库属于CA类型。

**CP**：如果有节点发生故障或网络中断，会存在部分数据不可用的情况。MongoDB、Redis等属于这种类型，它们都是主从的架构，主节点宕机会导致对应分片的数据不可写。

**AP**：可能会返回不准确的数据，但系统总是可用的，即使出现网络分区时也是如此。DNS是这类系统最知名的例子。Cassandra属性AP类型。

实际上，网络分区总是客观存在的，所以设计者要么选择牺牲一致性，要么选择牺牲可用性。

### 面向行

Cassandra是面向行的，数据存储在**稀疏**的**多维**散列表中。

“稀疏”是指，每一行可以有一个或多个列，但每一行不是必须有完全相同的列。

HBase是面向列的数据库，它主要用于分析用例。

在关系型数据库中，会提前定义一个表的所有列，并为每一列分配空间，而不论其中是否填充数据。

Cassandra将数据存储在一个多维的**有序散列表**中，一个列的数据会作为散列表中的一个key-value，如果某个列没有值，那就忽略那个列，这就能得到更高效的存储和查询处理。

### 灵活模式

BigTable和MongoDB等无模式数据库有很多优点，它们可以动态地定义新列，扩展性非常好。

但无模式数据库的主要缺点是很难确定数据的含义和格式。

很多初创项目最初可能由无模式的数据库获得了很大的灵活性，但当它们逐步发展壮大，需要众多开发人员维护的时候，无模式数据库就不试用了。

Cassandra不是无模式，它只是支持灵活模式。

### 大量写操作

Cassandra针对超大写吞吐量特别进行了优化。



