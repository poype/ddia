## 数仓分层

**ODS（Operational Data Store）层**

ODS 层存放原始数据，其结构与源系统很接近，基本是对业务系统数据的原样抽取。例如从多个不同数据库表直接抽取过来的数据，保留了原始业务数据的所有字段和格式。

ODS 层是数据仓库的最底层，主要是为后续的数据处理提供一个完整的数据基础。

**DWD（Data Warehouse Detail）层**

DWD 层是在 ODS 层基础上进行清洗和转换后的**明细**数据层。

以订单数据为例，在 DWD 层可能会将 ODS 层中订单时间格式不统一的数据进行统一格式化，清洗掉一些不合理的订单数据。

订单明细表还可能会把用户信息、商品信息、店铺信息等都放在一起，这样在统计订单相关数据的时候，就不需要去做多个表的连接操作，能有效提升查询性能，让数据获取更高效。

所以，多张ODS表中的数据可能会合并到一个DWD表中。

**DWS（Data Warehouse Service）层**

DWS是一个**轻度**汇总层，主要是对 DWD 层的明细数据按照一定的业务规则进行聚合。比如按照天、周、月等时间维度对销售订单金额进行汇总，或者按照地区、用户类别等维度对用户购买频次进行统计。

DWS为上层应用提供了更高效的数据分析服务，使得一些**常见的**、**粗粒度的**数据分析需求可以直接从这一层获取数据，而**不需要每次都从明细数据进行复杂的计算**。DWS 层的数据能够更快地提供**业务概览**和**关键指标**的统计情况。

DWS层的思想就是用空间换时间，通过对数据进行预聚合的方式，使上层的业务查询和计算更快，

DWS 层的主要目的之一就是通过**预聚合**操作来**提高查询性能**。当面对频繁的、具有**共性的**分析需求，如按天统计销售额、按地区统计订单数量等，如果每次都从 DWD 层的明细数据进行计算，会涉及大量的数据读取和复杂的聚合运算，这会消耗较多的时间和计算资源。

而 DWS 层提前按照这些常见的维度（如时间维度、地理维度等）对数据进行聚合，当需要这些粗粒度的统计信息时，直接从 DWS 层获取数据，大大减少了计算量，使得查询能够快速响应，为数据分析和决策提供更高效的支持。

**ADS（Application Data Store）层**

这是数据仓库的应用层，主要是面向具体的业务应用场景提供数据。这些数据是根据具体的业务需求，从 DWS 层**或** DWD 层经过进一步加工和计算得到的，是直接用于支持业务决策的数据层。

## 理解ADS

DWS是轻度汇总层，数据按照一定的**通用**业务规则和维度对 DWD 层明细数据进行聚合。

ADS是应用数据层，数据是根据**具体的**业务应用场景，从 **DWS 层或 DWD 层**进一步加工得到的。它的数据内容更具**针对性**，聚合程度可能更高或者更贴合特定业务需求。

例如，下面是DWS层和ADS层表结构的对比。

#### DWS 层表结构

 `dws_user_sales_daily`（用户每日销售汇总表）：

- **user_id**：用户编号
- **stat_date**：统计日期
- **order_count**：当天该用户的订单数量
- **total_amount**：当天该用户的消费总金额
- **avg_order_amount**：当天该用户的平均订单金额（`total_amount / order_count`）

#### ADS 层表结构

`ads_user_purchase_analysis`（用户购买行为分析报表），用于运营人员分析用户购买行为，以制定个性化营销策略。

- **user_id**：用户编号
- **recent_7d_order_count**：最近 7 天该用户的订单总数
- **recent_7d_total_amount**：最近 7 天该用户的消费总金额
- **recent_7d_avg_order_amount**：最近 7 天该用户的平均订单金额（`recent_7d_total_amount / recent_7d_order_count`）
- **category_preference**：用户最常购买的商品类别，格式为 JSON，如 `{"服装": 5, "电子产品": 3}`，表示购买服装 5 次，电子产品 3 次。
- **first_order_date**：用户首次下单日期
- **last_order_date**：用户最近一次下单日期

## 数仓分层的意义

一是解耦，各层独立运作互不干扰；

二是提升数据的复用性，避免重复处理；

三是降低计算代价，利用预处理数据；

四是构建公共数据层，打破烟囱式开发，让数据管理更高效。

## 大宽表

数仓中的DWD和DWS两层通常都会采用大宽表模式。

大宽表把跟某个业务过程相关的所有维度数据都整合到一张表中，减少了表之间关联查询的复杂度。

采用大宽表本质上是以空间换时间的策略。在大数据场景下，**存储成本相对计算资源和时间成本来说，有时是可以接受的权衡**。而且，**通过一些数据压缩技术，可以在一定程度上缓解数据冗余带来的存储压力**，同时保证数据查询和分析的高效性。

在列式存储的 OLAP 系统中，大宽表的空间浪费问题可以得到一定程度的缓解，列式存储系统能够有效地对数据进行压缩。

以一个外卖订单相关的 DWD 表为例，其内容不仅囊括了 ODS 层订单表的基础信息，还融合了店铺的详细地址、骑手接单时的实时位置、等待接单时长、选用的交通工具类型及配送距离，同时包含客户的收货地址信息。考虑到天气状况可能影响外卖配送时效，该表甚至还纳入了订单发生时的天气数据。

但也不是在一个表中加入的列越多越好，将哪些列加入到一张表中需要考虑如下因素：

1. 考虑业务分析中最常用的维度。如果按地区分析订单是经常进行的操作，就需要将用户地址信息整合进来。
2. 如果某些信息在数据分析中很少被用到，就不要整合进来，以避免表过于臃肿。
3. 从查询性能角度考虑，整合后的 DWD 层表应能够减少复杂的多表联合查询。
4. 频繁更新的信息不适合整合进DWD层的表。比如，将用户的实时积分信息整合到订单表，积分的频繁变动可能会增加数据维护的难度和成本。

### 星型模型的缺点

当数据量巨大时，星型模式中频繁的多表连接（`JOIN`）操作会带来性能瓶颈。因为在大数据环境下，**数据存储分布在多个节点上，进行表连接时需要跨节点的数据传输和匹配，这会消耗大量的计算资源和时间**。而像大宽表这种模式减少了表连接的操作，数据可以更高效地被读取和分析，所以**大宽表在海量数据场景下更具优势**。

## 数仓建设方法论

#### 需求分析(自上而下)

- 与企业内各部门沟通，了解他们的数据分析需求。
- 根据业务需求划分主题领域。
- 对每个主题领域进行详细描述，包括主题领域的范围、主要业务实体和相关业务规则。
- 确定关键指标，比如对于电商企业，关键指标可能包括订单量、销售额、客单价等。

#### 数据来源梳理(自下而上)

- 找出企业内部和外部的所有数据来源。内部可能包括各种业务系统，外部可能包括市场调研报告、行业数据平台等。
- 评估数据的质量，包括数据的准确性、完整性、一致性等，对质量差的数据要考虑清洗和转换的方法。

#### 数据建模

在明确了需求分析和梳理清楚所有的数据来源后，**核心任务便是依据各个数据源中的数据，生成满足业务需求的报表**。然而，这个转换过程并非简单直接，为了确保系统具备良好的可维护性、可扩展性，遵循职责单一性、功能可复用等特性至关重要，因此数仓分层显得尤为关键。

数仓通常分为ODS、DWD、DWS、ADS几个层次，每个层次都肩负着特定职责。

通过这样的数仓分层架构，各个层次各司其职，既保证了数据处理的高效性和准确性，又实现了功能的复用和职责的单一，从而高效地完成从数据源到业务报表的转换过程。